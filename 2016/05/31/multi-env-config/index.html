<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>多环境下的配置管理方案 | Gogap</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="CI,Micro," />
  

  <meta name="description" content="在开发中，我们需要面对各种各样的环境，开发环境、测试环境、生产环境…… 并且，各个环境的参数和配置各不相同，比如数据库连接，服务器配置等。我们怎样在不同环境中调用正确的配置？ 通过配置文件这是一种常见的思路，通过创建多个配置文件，但根据命名区分，比如开发环境为develop-app.conf，测试环境为testing-app.conf，生产环境为production-app.conf 我们通过在系">
<meta name="keywords" content="CI,Micro">
<meta property="og:type" content="article">
<meta property="og:title" content="多环境下的配置管理方案">
<meta property="og:url" content="http://gogap.cn/2016/05/31/multi-env-config/index.html">
<meta property="og:site_name" content="Gogap">
<meta property="og:description" content="在开发中，我们需要面对各种各样的环境，开发环境、测试环境、生产环境…… 并且，各个环境的参数和配置各不相同，比如数据库连接，服务器配置等。我们怎样在不同环境中调用正确的配置？ 通过配置文件这是一种常见的思路，通过创建多个配置文件，但根据命名区分，比如开发环境为develop-app.conf，测试环境为testing-app.conf，生产环境为production-app.conf 我们通过在系">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-09-19T06:23:11.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="多环境下的配置管理方案">
<meta name="twitter:description" content="在开发中，我们需要面对各种各样的环境，开发环境、测试环境、生产环境…… 并且，各个环境的参数和配置各不相同，比如数据库连接，服务器配置等。我们怎样在不同环境中调用正确的配置？ 通过配置文件这是一种常见的思路，通过创建多个配置文件，但根据命名区分，比如开发环境为develop-app.conf，测试环境为testing-app.conf，生产环境为production-app.conf 我们通过在系">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=eaf5ab1e" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#通过配置文件"><span class="toc-text">通过配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集中式配置管理"><span class="toc-text">集中式配置管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#读取配置"><span class="toc-text">读取配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写入配置"><span class="toc-text">写入配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多"><span class="toc-text">更多</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-multi-env-config" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">多环境下的配置管理方案</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.05.31</span>
      </span>

       
        <span class="article-author">
          <i class="icon-user"></i>
          <span>lubia</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <p>在开发中，我们需要面对各种各样的环境，开发环境、测试环境、生产环境……</p>
<p>并且，各个环境的参数和配置各不相同，比如数据库连接，服务器配置等。我们怎样在不同环境中调用正确的配置？</p>
<h2 id="通过配置文件"><a href="#通过配置文件" class="headerlink" title="通过配置文件"></a>通过配置文件</h2><p>这是一种常见的思路，通过创建多个配置文件，但根据命名区分，比如开发环境为<code>develop-app.conf</code>，测试环境为<code>testing-app.conf</code>，生产环境为<code>production-app.conf</code></p>
<p>我们通过在系统中设置环境变量<code>export ENV_MODE=develop</code>等等。在读取配置文件时，根据环境变量读取响应的配置文件。</p>
<p>这个方式易于使用，深得大家喜爱。但这个方案在集群扩大的一定程度时，会遇到一下几个主要问题：</p>
<ul>
<li>假如有30~40个微服务需要连接数据库运行，这个量级在中小型团队中很常见了，如果我们需要更改数据库密码，我们不得不将数十个project逐个进行更新，非常不灵活。</li>
<li>代码与配置掺杂在一起，代码是许多开发人员都可以看到的，也很容易泄露，而生产环境的各种秘钥应该只有少数人有权限能看到。这对系统的安全有重大影响。</li>
</ul>
<ul>
<li>对于大量相同的配置（比如数据库配置），逻辑上我们应该存放在同一个地方，保证只有唯一可靠的数据来源。</li>
</ul>
<p>对于这些问题，我们认为配置应该集中化管理。</p>
<p>集中化管理带来以下好处：</p>
<ul>
<li>各个服务间相同的配置只需要维护一分数据，保证唯一性</li>
<li>各个环境的配置环境实现权限隔离，少数人拥有查看生产环境配置的权限</li>
<li>更改配置将变得简单，不影响服务本身</li>
</ul>
<p>最简单的方案就是存储在<code>redis</code>中。KV的存储方式天然适合关联配置文件。但要完整的使用整个方案，需要做一些准备。</p>
<h2 id="集中式配置管理"><a href="#集中式配置管理" class="headerlink" title="集中式配置管理"></a>集中式配置管理</h2><p>我们的基本思路是：将配置文件的值替换为占位符，在系统启动时，相应的工具将根据占位符到<code>redis</code>中查询到实际的值，替换回配置文件。</p>
<p>最初的配置文件是这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;database_host&quot;:&quot;127.0.0.1&quot;,</div><div class="line">  &quot;database_port&quot;:3306</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在我们的配置文件变成了这样：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"database_host"</span>:<span class="string">"&#123;&#123;redis_hget "</span>global.mysql<span class="string">" "</span>host<span class="string">"&#125;&#125;"</span>,</div><div class="line">  "database_port":&#123;&#123;redis_hget "global.mysql" "port"&#125;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h2><p>在启动时，我们通过这个工具：<a href="https://github.com/gogap/env_json" target="_blank" rel="external">https://github.com/gogap/env_json</a></p>
<p>这样读取配置文件</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    data, _ := ioutil.ReadFile(<span class="string">"./db.conf"</span>)</div><div class="line">    dbConf := DBConfig&#123;&#125;</div><div class="line">    <span class="keyword">if</span> err := env_json.Unmarshal(data, &amp;dbConf); err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Print(err)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(dbConf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个工具，默认从<code>/etv/env_string.conf</code>读取<code>redis</code>的配置信息，当然你可以更改，更多细节参看说明文档。</p>
<p>在这个过程中，<code>env_json</code>首先会从<code>/etv/env_string.conf</code>读取到<code>redis</code>的配置信息。</p>
<p>典型的<code>/etv/env_string.conf</code>内容如下</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line"><span class="string">"storages"</span>: [&#123;</div><div class="line">        <span class="string">"engine"</span>: <span class="string">"redis"</span>,</div><div class="line">        <span class="string">"options"</span>: &#123;</div><div class="line">            <span class="string">"db"</span>: <span class="number">0</span>,</div><div class="line">            <span class="string">"password"</span>: <span class="string">""</span>,</div><div class="line">            <span class="string">"pool_size"</span>: <span class="number">10</span>,</div><div class="line">            <span class="string">"address"</span>: <span class="string">"127.0.0.1:6379"</span></div><div class="line">        &#125;</div><div class="line">    &#125;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>连接上<code>redis</code>后，以上面的例子来说，将执行<code>hget global.mysql host</code>以及<code>hget global.mysql port</code>，将取到的值通过模板替换，更新到配置文件中，得到一个正常的<code>json</code>文本，剩下的就是通过<code>json</code>库把<code>json</code>内容解码到结构体中。</p>
<p>到目前为止，我们实现了从<code>redis</code>中读取并替换配置，那么我们写入配置的时候呢？</p>
<p>假如我们有数十个服务，我们难道需要逐个去<code>redis</code>中设置吗？我们怎样把这个流程自动化？</p>
<h2 id="写入配置"><a href="#写入配置" class="headerlink" title="写入配置"></a>写入配置</h2><p>我们需要另一个工具：<a href="https://github.com/gogap/env_strings/tree/master/env_sync" target="_blank" rel="external">env_sync</a></p>
<p>我们存储配置文件其实是一个具体的git工程，比如开发环境是<code>develop_env</code>,生产环境是<code>production_env</code>，开发人员都可以编辑<code>develop_env</code>这个工程，少数人可以编辑<code>production_env</code>。</p>
<p>工程里的内容什么呢？</p>
<p>我们约定了这样的目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">develop_env</div><div class="line">	global.mysql    //this is folder</div><div class="line">         data       //this is file</div><div class="line">    components.accounts</div><div class="line">    	 data</div></pre></td></tr></table></figure>
<p>在工程中，有一系列的文件夹，文件夹中有一个叫data的文件。这样的目录结构会被<a href="https://github.com/gogap/env_strings/tree/master/env_sync" target="_blank" rel="external">env_sync</a>识别到，并转化成一系列的<code>redis</code>命令。</p>
<p>假如<code>global.mysql</code>文件夹下的<code>data</code>文件内容是</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"host"</span>:<span class="string">"127.0.0.1"</span>,</div><div class="line">  <span class="attr">"port"</span>:<span class="number">3306</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>转化出来的命令是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hset global.mysql host 127.0.0.1</div><div class="line">hset global.mysql port 3306</div></pre></td></tr></table></figure>
<p>此过程与读取过程正好相反，同样的，<a href="https://github.com/gogap/env_strings/tree/master/env_sync" target="_blank" rel="external">env_sync</a>也是从<code>/etc/env_strings.conf</code>读取配置信息。与读取工具保持了统一。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整体来看我们需要做几个工作</p>
<ul>
<li><p>为各个环境维护一个配置文件project</p>
</li>
<li><p>安装env_sync，便于同步配置文件到redis</p>
</li>
<li><p>设置<code>/etc/env_strings.conf</code></p>
</li>
<li><p>更改读取配置文件的代码，兼容env_json</p>
<p>​</p>
</li>
</ul>
<p>再结合<a href="http://lubia.cn/2016/05/30/deploy-micro/" target="_blank" rel="external">自动化部署工具</a>，每次配置文件有更新时，我们就在线上环境自动同步到redis。</p>
<h2 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h2><p>还有一种需求时，配置文件会动态变化，而我们不想重启服务就读取到配置文件，那你需要<a href="https://github.com/gogap/redconf" target="_blank" rel="external">https://github.com/gogap/redconf</a></p>
<p>这个工具可以实现对redis中数据的检测，如果数据发生变化，会触发回调，应用可以得到变化前后的值。 </p>

    
  </div>
  
    
<div class="share_jia">
   <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">
            分享到: &nbsp;
        </span>
<a class="jiathis_button_tsina"></a>
<a class="jiathis_button_weixin"></a>
<a class="jiathis_button_evernote"></a>
<a href="http://www.jiathis.com/share?uid=2102171" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=2102171" charset="utf-8"></script>
<!-- JiaThis Button END -->

</div>

  

</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'gogap';
    
    var disqus_url = 'http://gogap.cn/2016/05/31/multi-env-config/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//gogap.disqus.com/count.js" async></script>



    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
