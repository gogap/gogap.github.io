<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>Go语言如何在没有实现功能的情况下写出完善的单元测试代码 | Gogap</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="gogap,golang,micro,微服务,Go语言,micro service,流式编程,flow" />
  

  <meta name="description" content="背景最近在研究用Go写一个自己的解释型语言，有一本书叫《Writing An Interpreter In Go》, 作者在讲解如何编写解释器的时候，都是从写一个_test.go开始的，也就是说作者习惯于先写单元测试，以测试驱动开发，其实这是一个非常好的习惯，不过，作者在写_test.go文件的时候，都是先假设这个结构体、函数已经存在了，并且没有把关键的对象抽象成接口，因此，作者在运行go tes">
<meta property="og:type" content="article">
<meta property="og:title" content="Go语言如何在没有实现功能的情况下写出完善的单元测试代码">
<meta property="og:url" content="http://gogap.cn/2017/09/20/go-mock-test/index.html">
<meta property="og:site_name" content="Gogap">
<meta property="og:description" content="背景最近在研究用Go写一个自己的解释型语言，有一本书叫《Writing An Interpreter In Go》, 作者在讲解如何编写解释器的时候，都是从写一个_test.go开始的，也就是说作者习惯于先写单元测试，以测试驱动开发，其实这是一个非常好的习惯，不过，作者在写_test.go文件的时候，都是先假设这个结构体、函数已经存在了，并且没有把关键的对象抽象成接口，因此，作者在运行go tes">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-09-20T09:11:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Go语言如何在没有实现功能的情况下写出完善的单元测试代码">
<meta name="twitter:description" content="背景最近在研究用Go写一个自己的解释型语言，有一本书叫《Writing An Interpreter In Go》, 作者在讲解如何编写解释器的时候，都是从写一个_test.go开始的，也就是说作者习惯于先写单元测试，以测试驱动开发，其实这是一个非常好的习惯，不过，作者在写_test.go文件的时候，都是先假设这个结构体、函数已经存在了，并且没有把关键的对象抽象成接口，因此，作者在运行go tes">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=eaf5ab1e" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/atom.xml"
            target="_blank"
            >
            RSS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gomock-框架"><span class="toc-text">gomock 框架</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#期望接口调用参数"><span class="toc-text">期望接口调用参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#期望返回值"><span class="toc-text">期望返回值</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gomock-实战"><span class="toc-text">gomock 实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lexer和Token"><span class="toc-text">Lexer和Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试思路"><span class="toc-text">测试思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用gomock"><span class="toc-text">使用gomock</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装gomock"><span class="toc-text">安装gomock</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成mock代码"><span class="toc-text">生成mock代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编写lexer-test-go"><span class="toc-text">编写lexer_test.go</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#测试数据"><span class="toc-text">测试数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成一个真实的MonkeyLexer实例"><span class="toc-text">生成一个真实的MonkeyLexer实例</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#构建MockLexer实例"><span class="toc-text">构建MockLexer实例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用mock实例进行测试"><span class="toc-text">使用mock实例进行测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用真实实例测试"><span class="toc-text">使用真实实例测试</span></a></li></ol></li></ol></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-go-mock-test" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Go语言如何在没有实现功能的情况下写出完善的单元测试代码</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.09.20</span>
      </span>

       
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Gogap</span>
        </span>
      

      


      

    </div>
  </header>

  <div class="article-content">
    
      <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在研究用Go写一个自己的解释型语言，有一本书叫《Writing An Interpreter In Go》, 作者在讲解如何编写解释器的时候，都是从写一个<code>_test.go</code>开始的，也就是说作者习惯于先写单元测试，以测试驱动开发，其实这是一个非常好的习惯，不过，作者在写<code>_test.go</code>文件的时候，都是先假设这个结构体、函数已经存在了，并且没有把关键的对象抽象成接口，因此，作者在运行<code>go test</code>的时候，是无法完成测试的，因为连编译都过不了，必须一边完善代码，一边重复运行<code>go test</code>，一直到完成开发。</p>
<p>基于这种开发模式下，其实我更期望能有一个Mock实现，写测试代码的时候畅通无阻，即使是没有实现，也能把各个测试用例覆盖到，当真实的实现完成后，我们只需要把mock实现替换成真实的实现就好了。</p>
<p>这么做还带来另一个好处，如果公司有SDET岗位，则可以直接让测试人员编写单元测试，开发任务和测试任务可以并行。</p>
<hr>
<h2 id="gomock-框架"><a href="#gomock-框架" class="headerlink" title="gomock 框架"></a>gomock 框架</h2><p>昨天闲着没事逛了逛 <a href="https://github.com/golang" target="_blank" rel="external">https://github.com/golang</a>, 发现了一个非常有意思的框架: <a href="https://github.com/golang/mock" target="_blank" rel="external">gomock</a>, 官方的描述是，这是一个mocking framework, 在使用上也很简单，大致的步骤如下：</p>
<p>1、定义一个待实现的接口.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> MyInterface <span class="keyword">interface</span> &#123;</div><div class="line">  SomeMethod(x <span class="keyword">int64</span>, y <span class="keyword">string</span>)</div><div class="line">  GetSomething() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、使用<code>mockgen</code>生成mock代码.</p>
<p>3、测试:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestMyThing</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    mockCtrl := gomock.NewController(t)</div><div class="line">    <span class="keyword">defer</span> mockCtrl.Finish()</div><div class="line">    </div><div class="line">    mockObj := something.NewMockMyInterface(mockCtrl)</div><div class="line">    mockObj.EXPECT().SomeMethod(<span class="number">4</span>, <span class="string">"blah"</span>)</div><div class="line">    mockObj.EXPECT().GetSomething.Return(<span class="string">"haha"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看了这个步骤，想必大家应该猜到了，mocking framework 使用的是根据你的接口定义来自动生成一个Mock实现，我们还可以往这个实现里注入数据。</p>
<h3 id="期望接口调用参数"><a href="#期望接口调用参数" class="headerlink" title="期望接口调用参数"></a>期望接口调用参数</h3><p>我们可以通过 <code>.EXPECT()</code> 为这个mock对象注入期望值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mockObj.EXPECT().SomeMethod(<span class="number">4</span>, <span class="string">"blah"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>测试通过:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mockObj.SomeMethod(<span class="number">4</span>, <span class="string">"blah"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>测试不通过:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mockObj.SomeMethod(<span class="number">5</span>, <span class="string">"bldah"</span>) <span class="comment">// 此处调用时直接会抛出错误</span></div></pre></td></tr></table></figure>
<p>对于参数类型的期望，在调用这个Mock函数的时候会直接抛错异常</p>
<h3 id="期望返回值"><a href="#期望返回值" class="headerlink" title="期望返回值"></a>期望返回值</h3><p><code>.EXPECT()</code> 同样可以为某个函数注入返回值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mockObj.EXPECT().GetSomething().Return(<span class="string">"haha"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>测试通过:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="string">"haha"</span> == mockObj.GetSomething() &#123;</div><div class="line">    <span class="comment">// -&gt; 执行到这里</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<ul>
<li>测试不通过:</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="string">"haha"</span> == mockObj.GetSomething() &#123;</div><div class="line">    <span class="comment">// -&gt; 不会执行到这里</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// ...</span></div></pre></td></tr></table></figure>
<p>功能强的还不止这个，如果我们在测试一个循环，希望的是每次调用 <code>GetSomething()</code> 都返回不同的值，该怎么办？</p>
<p>答案很简单，依次调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">gomock.InOrder(</div><div class="line">    mockObj.EXPECT().GetSomething().Return(<span class="string">"A"</span>),</div><div class="line">    mockObj.EXPECT().GetSomething().Return(<span class="string">"B"</span>),</div><div class="line">    mockObj.EXPECT().GetSomething().Return(<span class="string">"C"</span>),</div><div class="line">)</div></pre></td></tr></table></figure>
<p>接下来，让我们来实战一下吧。</p>
<hr>
<h2 id="gomock-实战"><a href="#gomock-实战" class="headerlink" title="gomock 实战"></a>gomock 实战</h2><p>我们以《Writing An Interpreter In Go》这本书中的 <code>monkey</code> 语言的 <code>lexer</code> 作为例子</p>
<p>我们看一下 <code>monkey</code> 的目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">monkey&gt; tree .</div><div class="line">.</div><div class="line">├── lexer</div><div class="line">│   ├── lexer.go</div><div class="line">│   ├── lexer_test.go</div><div class="line">│   └── mock_lexer</div><div class="line">│       └── mock_lexer.go</div><div class="line">└── token</div><div class="line">    └── token.go</div></pre></td></tr></table></figure>
<h3 id="Lexer和Token"><a href="#Lexer和Token" class="headerlink" title="Lexer和Token"></a>Lexer和Token</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">type Lexer interface &#123;</div><div class="line">	NextToken() token.Token</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>lexer的功能很简单，每次调用<code>NextToken()</code>，都是返回下一个<code>Token</code><br><code>Token</code>的结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">type TokenType string</div><div class="line"></div><div class="line">type Token struct &#123;</div><div class="line">	Type    TokenType   // 类型</div><div class="line">	Literal string      // 内容</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>比如下面的<code>go</code>语句</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="number">1</span></div></pre></td></tr></table></figure>
<p>lexter 在调用三次<code>NextToken()</code>后会得到三个Token, 依次是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Token&#123;VAR, var&#125;</div><div class="line">Token&#123;IDENT, a&#125;</div><div class="line">Token&#123;INT, 1&#125;</div></pre></td></tr></table></figure>
<h3 id="测试思路"><a href="#测试思路" class="headerlink" title="测试思路"></a>测试思路</h3><p>其实测试方法就是：给定一段代码，用Lexer解析后，能得到指定顺序的Token，而<code>gomock</code>是完全可以实现的。</p>
<h3 id="使用gomock"><a href="#使用gomock" class="headerlink" title="使用gomock"></a>使用gomock</h3><h4 id="安装gomock"><a href="#安装gomock" class="headerlink" title="安装gomock"></a>安装gomock</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">go get github.com/golang/mock/gomock</div><div class="line">go get github.com/golang/mock/mockgen</div></pre></td></tr></table></figure>
<h4 id="生成mock代码"><a href="#生成mock代码" class="headerlink" title="生成mock代码"></a>生成mock代码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mockgen -<span class="built_in">source</span> lexer.go -destination  mock_lexer/mock_lexer.go</div></pre></td></tr></table></figure>
<h3 id="编写lexer-test-go"><a href="#编写lexer-test-go" class="headerlink" title="编写lexer_test.go"></a>编写lexer_test.go</h3><h4 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h4><p>input: 输入的语句<br>tokens: 期望的Token</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getTestData</span><span class="params">()</span> <span class="params">(input <span class="keyword">string</span>, tokens []token.Token)</span></span> &#123;</div><div class="line">	input = <span class="string">`</span></div><div class="line"><span class="string">let five = 5;</span></div><div class="line"><span class="string">let ten = 10;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line">	tokens = []token.Token&#123;</div><div class="line">		&#123;token.LET, <span class="string">"let"</span>&#125;,</div><div class="line">		&#123;token.IDENT, <span class="string">"five"</span>&#125;,</div><div class="line">		&#123;token.ASSIGN, <span class="string">"="</span>&#125;,</div><div class="line">		&#123;token.INT, <span class="string">"5"</span>&#125;,</div><div class="line">		&#123;token.SEMICOLON, <span class="string">";"</span>&#125;,</div><div class="line">		&#123;token.LET, <span class="string">"let"</span>&#125;,</div><div class="line">		&#123;token.IDENT, <span class="string">"ten"</span>&#125;,</div><div class="line">		&#123;token.ASSIGN, <span class="string">"="</span>&#125;,</div><div class="line">		&#123;token.INT, <span class="string">"10"</span>&#125;,</div><div class="line">		&#123;token.SEMICOLON, <span class="string">";"</span>&#125;,</div><div class="line">		&#123;token.EOF, <span class="string">""</span>&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="生成一个真实的MonkeyLexer实例"><a href="#生成一个真实的MonkeyLexer实例" class="headerlink" title="生成一个真实的MonkeyLexer实例"></a>生成一个真实的MonkeyLexer实例</h4><p>当然，这里我们没有实现，所以返回是<code>nil</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMonkeyLexer</span><span class="params">(input <span class="keyword">string</span>, excepts []token.Token, t *testing.T)</span> <span class="params">(l Lexer, deferFN <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">	<span class="comment">// return NewMonkeyLexer(input), func() &#123;&#125;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="构建MockLexer实例"><a href="#构建MockLexer实例" class="headerlink" title="构建MockLexer实例"></a>构建MockLexer实例</h4><p>由于没写完真正的lexer, 那么我们就开始Mock吧</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMockLexer</span><span class="params">(input <span class="keyword">string</span>, excepts []token.Token, t *testing.T)</span> <span class="params">(l Lexer, deferFN <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line"></div><div class="line">	ctrl := gomock.NewController(t)</div><div class="line"></div><div class="line">	<span class="comment">// 生成一个Mock实例</span></div><div class="line">	mockLexter := mock_lexer.NewMockLexer(ctrl)</div><div class="line"></div><div class="line">    <span class="comment">// 将期望值一次传递给 NextToken()</span></div><div class="line">    <span class="comment">// 每次调用 NextToken() 也会依次获得期望值</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(excepts); i++ &#123;</div><div class="line">		mockLexter.EXPECT().NextToken().Return(excepts[i])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	l = mockLexter</div><div class="line">	</div><div class="line">	<span class="comment">// 用于清理</span></div><div class="line">	deferFN = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; ctrl.Finish() &#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了方便在mock实例和真实实例之间进行切换，我们可以通过环境变量来控制当前的测试实例是什么，如果要使用mock进行测试，我们只需要在运行 <code>go test</code> 前执行:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; export GO_MOCK_TEST=<span class="number">1</span></div></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; GO_MOCK_TEST=<span class="number">1</span> <span class="keyword">go</span> test -v</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newLexer</span><span class="params">(input <span class="keyword">string</span>, excepts []token.Token, t *testing.T)</span> <span class="params">(l Lexer, deferFN <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">	env := os.Getenv(<span class="string">"GO_MOCK_TEST"</span>)</div><div class="line">	<span class="keyword">if</span> env == <span class="string">"1"</span> &#123;</div><div class="line">		t.Log(<span class="string">"MOCK TEST ENABLED!!!"</span>)</div><div class="line">		<span class="keyword">return</span> newMockLexer(input, excepts, t)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> newMonkeyLexer(input, excepts, t)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是真正的测试代码，在没真实实现<code>monkey lexer</code>的情况下，我们可以写测试代码了，而且如果运行 <code>go test -v</code> 也是能通过的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestNextToken</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line"></div><div class="line">	input, excepts := getTestData()</div><div class="line"></div><div class="line">	l, fn := newLexer(input, excepts, t) <span class="comment">// 生成 Lexer 对象</span></div><div class="line"></div><div class="line">	<span class="keyword">defer</span> fn() <span class="comment">// 清理</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> i, tt := <span class="keyword">range</span> excepts &#123;</div><div class="line">		tok := l.NextToken()  <span class="comment">// 获取下一个Token</span></div><div class="line"></div><div class="line">		<span class="keyword">if</span> tok.Type != tt.Type &#123;</div><div class="line">			t.Fatalf(<span class="string">"tests[%d] - tokentype wrong. expected=%q, got=%q"</span>,</div><div class="line">				i, tt.Type, tok.Type)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> tok.Literal != tt.Literal &#123;</div><div class="line">			t.Fatalf(<span class="string">"tests[%d] - literal wrong. expected=%q, got=%q"</span>,</div><div class="line">				i, tt.Literal, tok.Literal)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>下载完整的代码：<br><a href="https://github.com/xujinzheng/monkey" target="_blank" rel="external">https://github.com/xujinzheng/monkey</a></p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><h4 id="使用mock实例进行测试"><a href="#使用mock实例进行测试" class="headerlink" title="使用mock实例进行测试"></a>使用mock实例进行测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">monkey&gt; <span class="built_in">cd</span> lexer</div><div class="line">lexer&gt; GO_MOCK_TEST=1 go <span class="built_in">test</span> -v</div><div class="line"></div><div class="line">=== RUN   TestNextToken</div><div class="line">--- PASS: TestNextToken (0.00s)</div><div class="line">PASS</div><div class="line">ok  	github.com/xujinzheng/monkey/lexer	0.007s</div></pre></td></tr></table></figure>
<h4 id="使用真实实例测试"><a href="#使用真实实例测试" class="headerlink" title="使用真实实例测试"></a>使用真实实例测试</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMonkeyLexer</span><span class="params">(input <span class="keyword">string</span>, excepts []token.Token, t *testing.T)</span> <span class="params">(l Lexer, deferFN <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">	<span class="keyword">return</span> NewMonkeyLexer(input), <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们将测试数据修改一下，假设 <code>ten=666</code>, 但不修改期望值，让测试报错</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">input = <span class="string">`</span></div><div class="line"><span class="string">let five = 5;</span></div><div class="line"><span class="string">let ten = 666;</span></div><div class="line"><span class="string">`</span></div></pre></td></tr></table></figure>
<p>再次运行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">monkey&gt; <span class="built_in">cd</span> lexer</div><div class="line">lexer&gt; go <span class="built_in">test</span> -v</div><div class="line"></div><div class="line">=== RUN   TestNextToken</div><div class="line">--- FAIL: TestNextToken (0.00s)</div><div class="line">	lexer_test.go:52: tests[8] - literal wrong. expected=<span class="string">"10"</span>, got=<span class="string">"666"</span></div><div class="line">FAIL</div><div class="line"><span class="built_in">exit</span> status 1</div><div class="line">FAIL	github.com/xujinzheng/monkey/lexer	0.008s</div></pre></td></tr></table></figure>
<p>这里就报错了，说明我们的真实实例实现得有问题，需要修复这个BUG</p>
<p><code>gomock</code> 的使用到这里就结束了，除了上面介绍到的一些功能，<code>gomock</code> 还有很多其他丰富的方法，大家可以去 <a href="https://godoc.org/github.com/golang/mock/gomock" target="_blank" rel="external">GoDoc</a> 获取更详细的接口信息。</p>
<p>欢迎关注我的微信公众账号: <code>DeepIn-z</code></p>

    
  </div>
  
    
<div class="share_jia">
   <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">
            分享到: &nbsp;
        </span>
<a class="jiathis_button_tsina"></a>
<a class="jiathis_button_weixin"></a>
<a class="jiathis_button_evernote"></a>
<a href="http://www.jiathis.com/share?uid=2102171" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	data_track_clickback:true,
	summary:"",
	shortUrl:false,
	hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=2102171" charset="utf-8"></script>
<!-- JiaThis Button END -->

</div>

  

</article>

</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/atom.xml"
              target="_blank"
              >
              RSS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'gogap';
    
    var disqus_url = 'http://gogap.cn/2017/09/20/go-mock-test/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//gogap.disqus.com/count.js" async></script>



    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
